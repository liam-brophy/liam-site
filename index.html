<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link id="dynamic-favicon" rel="icon" type="image/jpeg" href="/favicons/NewFavicons.jpg" />
    <link rel="icon" href="/favicons/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" href="/favicons/favicon-512.png" sizes="512x512" />
    <link rel="apple-touch-icon" href="/favicons/apple-touch-icon.png" />

    <!-- Social preview / Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Liam Allaire" />
    <meta property="og:description" content="Designer working in publishing, development, and creative technology." />
    <meta property="og:image" content="https://liam.site/social-preview.jpg" />
    <meta property="og:url" content="https://liam.site/" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Liam Allaire" />
    <meta name="twitter:description" content="Designer working in publishing, development, and creative technology." />
    <meta name="twitter:image" content="https://liam.site/social-preview.jpg" />

    <!-- Adobe Fonts (Typekit) -->
    <link rel="stylesheet" href="https://use.typekit.net/kbv3wdg.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liam Allaire</title>
    <style>
      /* Ensure fonts are loaded with proper settings */
      @import url("https://use.typekit.net/kbv3wdg.css");
    </style>
    <script>
      (function() {
        // Use canvas to render frames into PNG data-URIs so desktop browsers accept the animated favicon
        const frames = [
          '/favicons/NewFavicons.jpg',
          '/favicons/NewFavicons2.jpg',
          '/favicons/NewFavicons3.jpg',
          '/favicons/NewFavicons4.jpg',
          '/favicons/NewFavicons5.jpg'
        ];
        const intervalMs = 800;

        // Respect reduced motion
        const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        const createOrGetLink = () => {
          let link = document.getElementById('dynamic-favicon');
          if (link && link.tagName !== 'LINK') link = null;
          if (!link) {
            link = document.createElement('link');
            link.id = 'dynamic-favicon';
            link.rel = 'icon';
            link.type = 'image/png';
            document.head.appendChild(link);
          }
          return link;
        };

        const preloadImages = (urls) => {
          return Promise.all(urls.map(url => new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = url + '?v=' + Date.now(); // Cache-bust to ensure fresh data
          })));
        };

        const startAnimation = (images) => {
          if (prefersReduced || !images.length) {
            const link = createOrGetLink();
            link.href = images[0] ? images[0].src : '/favicons/favicon-32x32.png';
            return;
          }

          const canvas = document.createElement('canvas');
          const size = 32; // favicon size in px
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');

          let idx = 0;
          const link = createOrGetLink();

          const frameToDataUrl = (img) => {
            // Clear and draw centered
            ctx.clearRect(0, 0, size, size);
            // Draw the image fitting into the square while preserving aspect ratio
            const ratio = Math.min(size / img.width, size / img.height);
            const w = img.width * ratio;
            const h = img.height * ratio;
            const x = (size - w) / 2;
            const y = (size - h) / 2;
            ctx.drawImage(img, x, y, w, h);
            return canvas.toDataURL('image/png');
          };

          // Set initial frame
          link.href = frameToDataUrl(images[0]);

          const intervalId = setInterval(() => {
            idx = (idx + 1) % images.length;
            try {
              link.href = frameToDataUrl(images[idx]);
            } catch (e) {
              // If drawing fails, stop animation and restore a static icon
              console.error('Favicon frame draw failed:', e);
              clearInterval(intervalId);
              link.href = '/favicons/favicon-32x32.png';
            }
          }, intervalMs);

          // Clean up on unload
          window.addEventListener('beforeunload', () => clearInterval(intervalId));
        };

        const start = async () => {
          try {
            const images = await preloadImages(frames);
            startAnimation(images);
          } catch (e) {
            console.warn('Favicon frames failed to preload; using static favicon', e);
            const link = createOrGetLink();
            link.href = '/favicons/favicon-32x32.png';
          }
        };

        if (document.readyState === 'complete') {
          start();
        } else {
          window.addEventListener('load', start);
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
